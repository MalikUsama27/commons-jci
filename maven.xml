<?xml version="1.0"?>
<project
  xmlns:j="jelly:core"
  xmlns:util="jelly:util"
  xmlns:ant="jelly:ant"
  >

<goal name="jar:minimal-dependency-jars">
  <ant:echo>dep: ${maven.dependency.classpath}</ant:echo> 
  <ant:echo>build: ${maven.build.dir}</ant:echo> 
</goal>

<goal name="jar:embeddable-jar">
  <attainGoal name="jar:jar"/>

  <j:set var="embeddable.jar.dir" value="${maven.build.dir}/embeddable/jar"/>
  <j:set var="embeddable.src.dir" value="${maven.build.dir}/embeddable/src"/>
  <j:set var="embeddable.dst.dir" value="${maven.build.dir}/embeddable/dst"/>

  <delete dir="${embeddable.jar.dir}"/>
  <delete dir="${embeddable.src.dir}"/>
  <delete dir="${embeddable.dst.dir}"/>

  <mkdir dir="${embeddable.jar.dir}"/>
  <mkdir dir="${embeddable.src.dir}"/>
  <mkdir dir="${embeddable.dst.dir}"/>

  <j:forEach var="lib" items="${pom.artifacts}">
    <j:set var="dep" value="${lib.dependency}"/>
    <ant:copy todir="${embeddable.jar.dir}" file="${lib.path}"/>
  </j:forEach>

  <copy file="${maven.build.dir}/${maven.final.name}.jar" toDir="${embeddable.jar.dir}"/>

  <unzip dest="${embeddable.src.dir}">
    <fileset dir="${embeddable.jar.dir}">
      <include name="*.jar"/>
    </fileset>
  </unzip>

<!--
  <copy toDir="${embeddable.dir}/META-INF">
    <fileset dir="${basedir}">
      <include name="ASM-LICENSE.txt"/>
    </fileset>
  </copy>
-->

  <taskdef name="jarjar"
           classname="com.tonicsystems.jarjar.JarJarTask"
           classpath="${pom.getDependencyPath('com.tonicsystems:jarjar')}"/>
  <jarjar jarfile="${maven.build.dir}/${pom.artifactId}-${pom.currentVersion}-embeddable.jar" 
          manifest="${embeddable.src.dir}/META-INF/MANIFEST.MF">
    <fileset dir="${embeddable.src.dir}">
      <exclude name="com/tonicsystems/jarjar/**"/>       
      <exclude name="junit/**"/>       
      <exclude name="net/sf/maven_plugins/cobertura/**"/>       
      <exclude name="org/apache/commons/logging/**"/>
      <exclude name="org.codehaus.groovy/**"/>
      <exclude name="groovyjarjarantlr/**"/>
      <exclude name="groovyjarjarasm/**"/>
      <exclude name="groovy/**"/>
      <exclude name="org/codehaus/janino/**"/>
      <exclude name="org/codehaus/groovy/**"/>
      <exclude name="org/eclipse/jdt/**"/>
      <exclude name="uk/org/xml/sax/**"/>
      <exclude name="uk/co/wilson/**"/>
      <exclude name="plugin-resources/**"/>
      <exclude name="plugin**"/>
      <exclude name="project**"/>
      <exclude name="*.css"/>
      <exclude name="*.html"/>
      <exclude name="*.jar"/>
      <exclude name=".*"/>
      <exclude name="META-INF/**"/>
    </fileset>
    <rule pattern="org.apache.commons.io.**" result="jarjar.orgapachecommonsio.@1"/>
    <rule pattern="org.apache.commons.lang.**" result="jarjar.orgapachecommonslang.@1"/>
    <rule pattern="org.apache.commons.collections.**" result="jarjar.orgapachecommonscollections.@1"/>
  </jarjar>

</goal>

</project>
